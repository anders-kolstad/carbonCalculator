---
title: "Interpolation_Opelandsmarka_20220111"
author: "MarteFandrem"
date: "11 1 2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Packages needed
```{r, echo=FALSE} 
library(readxl)
library(writexl)
library(rgdal)
library(raster)
library(ggplot2)
library(gstat)
library(sf)
library(broom)
library(ggthemes)
library(viridis)
library(sp)
library(spatialEco)
library(spm)
library(tmap)
library(Metrics)
library(rlist)
library(dplyr)
library(tmaptools)
library(shinyjs)
library(rgeos)
library(automap)
```


#Import and clean up data

```{r}

shp<-readOGR(dsn="C:/Users/martef/OneDrive - NTNU/Documents/Jobb-pc/PhD prosjekter/WP3 NINA GRAN/Data/Rydda datasett for kalkulator/Opelandsmarka", layer="Opelandsmarka")

df <- read.csv("C:/Users/martef/OneDrive - NTNU/Documents/Jobb-pc/PhD prosjekter/WP3 NINA GRAN/Data/Rydda datasett for kalkulator/Opelandsmarka/Torvdybder_Opelandsmarka.csv", sep=";")


#Clean up data

df <- na.omit(df, col.name = "Dybde", margin=1)
df <- df %>% 
   mutate(Dybde_m = Dybde / 100)
# Make spatial dataframe of the peat depths points

dfs <- st_as_sf(x = df, 
                        coords = c("x", "y"),
                        crs = "+init=epsg:25832")
#GDAL Message 1: +init=epsg:XXXX syntax is deprecated. It might return a CRS with a non-EPSG compliant axis order.
#Don't know how to write it otherwise. Seems to work properly though.

# Make sf file from sp shapefile
sf_shp <- st_as_sf(shp)

#Check projections
sf::st_crs(shp)
sf::st_crs(dfs)

#set same projection on all files
proj4string(shp)<-crs(dfs)

#make spatial file from data frame file
dfsp <- as(dfs, Class="Spatial")

#Crop dfsp to the extent of the station area
#dfsp_shp <- dfsp[shp,]


```

#Visualisere dataene

```{r}
tmap_mode("view")
  tm_shape(sf_shp)+
  tm_polygons() +
  tm_shape(dfs)+
  tm_dots(col="black", size=0.01, alpha=0.5, )

```

```{r}
data_Opelandsmarka <- tmap_mode("plot")+
                tm_shape(sf_shp)+
                 tm_polygons() +   
              tm_shape(dfs)+
              tm_dots(col="Dybde_m", alpha=1, palette="-viridis", size=0.5 ) +
              tm_layout(legend.outside = TRUE)

setwd('..')
#tmap::tmap_save(data_Opelandsmarka, "Output/Opelandsmarka/data_Opelandsmarka.png")
data_Opelandsmarka
```


#Create grid and adjust to extent of peatland

```{r}
grid <- raster(extent(shp)) #create a raster grid from the extent of the peatland
res(grid) <- 1              #set resolution of the grid to 1x1m
proj4string(grid)<-crs(dfs) #set similar projection to the grid as to the datapoints

grid_sp <-as(grid, "SpatialPixels") #convert the grid from raster to spatialpixels

grid_sp@grid@cellsize       #check that cell size is 1x1

grid_crop <- grid_sp[shp,]  #crop the grid to only include the peatland
plot(grid_crop)
```

#Test the best fit of nmax and power in IDW.
First interpolate all the various models and get the volume
```{r, echo=FALSE}
neighbors = length(dfsp$Dybde)
power = c(seq(from = 1, to = 4, by = 1))
neigh = c((1), seq(from=2,to=30,by = 2), c(length=(neighbors)))

temp <- data.frame()

for (i in power) {
  for (j in neigh) {
    
    temp2 <- NULL
    temp3 <- NULL
    temp4 <- NULL

    run = paste(i, j, sep="_")

    print(run)
    temp2 <- idw(Dybde_m ~ 1, dfsp, grid_crop, nmax=j, idp=i)
    temp3 <- as.data.frame(temp2@data)
    temp4 <- sum(temp3$var1.pred)
    temp5 <- cbind(run, temp4)
    temp  <- rbind(temp, temp5)
  }
} 


```

```{r}
volume <- temp
volume <-dplyr::rename(volume, volume=temp4)
volume <- tidyr::separate(volume, 
                        run, 
                        into = c("power", "nn"),
                        sep = "_",
                        remove=F)
volume$power <- as.numeric(volume$power)
volume$nn <- as.numeric(volume$nn)
volume$volume <- as.numeric(volume$volume)

setwd('..')
write.csv(volume, "Output/volume_Opelandsmarka.csv")
```
#Values for printing (mean, min, max, SD)
```{r}
max <- max(volume$volume)
min <- min(volume$volume)
mean <- mean(volume$volume)
sd <- sd(volume$volume)


Description <- c("mean", "min", "max", "SD")
Results_volume <- data.frame(Description, Results = c(mean, min, max, sd)) 

```


Get parameters for closest interpolation to the mean volume
```{r}
vol.mean <- which.min(abs(volume$volume - mean(volume$volume)))
  power.vol.mean <- volume$power[vol.mean]
  nn.vol.mean <- volume$nn[vol.mean]
  vol.mean <- volume$volume[vol.mean]

parameters.vol.mean <- cbind(power.vol.mean, nn.vol.mean, vol.mean)
print(parameters.vol.mean) 
```
This is interesting, as these are the same parameters that come out as the best ones according to the error indices (later in the script)

The span of max/min centered around the mean (+/-) in percentage
```{r}
(sumvol$volume[6]-sumvol$volume[1])/2/sumvol$volume[4]*100
```

Get area
```{r}
  sf::st_area(sf_shp)
```
Plot volume
```{r}
ggplot(data = volume,
       aes(x = nn, y = volume))+
  geom_line(size = 1)+
  geom_point(size = 2)+
   theme_bw(base_size = 20)+
  facet_wrap(.~factor(power))
```

#Then run jackknifing (leave-one-out) cross-validation
```{r}

#Then run for-loop for the LOOCV
neighbors = length(dfsp)
power = c(seq(from = 1, to = 4, by = 1))
neigh = c((1), seq(from=2,to=30,by = 2), c(length=(neighbors)))



temp <- data.frame()

for (i in power) {
  for (j in neigh) {
    
    temp2 <- NULL
    temp3 <- NULL
    temp4 <- NULL

    run = paste(i, j, sep="_")

    print(run)
    temp2 <- krige.cv(Dybde_m ~ 1, dfsp, nmax=j, set = list(idp=i))
    temp3 <- as.data.frame(temp2@data)
    temp3 <- cbind(run, temp3)
    
    temp4 <- as.data.frame(temp2@coords)
    temp4 <- temp4[,1:2]
    temp3 <- cbind(temp3, temp4)
    
    temp <- rbind(temp, temp3)
  }
} 


```

```{r}
df_results <- temp
setwd('..')
write.csv(df_results, "Output/LOOCV_results_Opelandsmarka.csv")
```

We can then evaluate fit with various parameters.
- mean error (ME), ideally 0
- correlation observed and predicted, ideally 1
- Root Mean Square Error (RMSE), ideally low
- Mean Absolute Error (MAE), ideally low


We extract all diagnostics from the CV (RMSE, MAE, correlation, ME)
```{r}
RMSE <- function(observed, predicted) {
  sqrt(mean((predicted - observed)^2, na.rm=TRUE))
  }

df_agg <- data.frame()



for(i in unique(df_results$run)){
  
  temp  <- NULL
  myRMSE <- NULL
  myCor <- NULL
  myME <- NULL
  myMAE <- NULL
  temp2 <- NULL

  
  temp <- df_results[df_results$run==i,]
  myRMSE <- RMSE(temp$observed, temp$var1.pred)
  myCor <- cor(temp$observed, temp$observed - temp$residual)
  myME <- mean(temp$residual)
  myMAE <- mae(temp$observed,temp$var1.pred)
  temp2 <- c(i, myRMSE, myCor, myME, myMAE)
  
  df_agg <- rbind(df_agg, temp2)
}

names(df_agg) <- c("run", "RMSE", "cor", "ME", "MAE")
df_agg$RMSE <- as.numeric(df_agg$RMSE)
df_agg$cor <- as.numeric(df_agg$cor)
df_agg$ME <- as.numeric(df_agg$ME)
df_agg$MAE <- as.numeric(df_agg$MAE)
df_agg$run2 <- as.numeric(row.names(df_agg))

```

```{r}
df_agg <- tidyr::separate(df_agg, 
                        run, 
                        into = c("power", "nn"),
                        sep = "_",
                        remove=F)
df_agg$power <- as.numeric(df_agg$power)
df_agg$nn <- as.numeric(df_agg$nn)

setwd('..')
write.csv(df_agg, "Output/LOOCV_parameters_Opelandsmarka.csv")
```

#Then plot the diagnostics over the parameters power and nn, to find the best fitted model
First plot: RMSE

```{r}
ggplot(df_agg, aes(nn, power)) + 
  geom_tile(aes(fill = RMSE), colour = "black") + 
  scale_fill_gradient(low = "steelblue", high = "orange") + 
  theme_bw() +
  ggtitle('Parameter values')
```


Second plot: MAE
```{r}
ggplot(df_agg, aes(nn, power)) + 
  geom_tile(aes(fill = MAE), colour = "black") + 
  scale_fill_gradient(low = "steelblue", high = "orange") + 
  theme_bw() +
  ggtitle('Parameter values')
```
```{r}
ggplot(df_agg, aes(nn, power)) + 
  geom_tile(aes(fill = ME), colour = "black") + 
  scale_fill_gradient(low = "steelblue", high = "orange") + 
  theme_bw() +
  ggtitle('Parameter values')
```
```{r}
ggplot(df_agg, aes(nn, power)) + 
  geom_tile(aes(fill = cor), colour = "black") + 
  scale_fill_gradient(low = "steelblue", high = "orange") + 
  theme_bw() +
  ggtitle('Parameter values')
```

Sum up the evaluation indices:

```{r}

sumass <-as.data.frame(do.call(cbind, lapply(df_agg, summary)))
sumass$power <- as.numeric(sumass$power)
sumass$nn <- as.numeric(sumass$nn)
sumass$RMSE <- as.numeric(sumass$RMSE)
sumass$cor <- as.numeric(sumass$cor)
sumass$MAE <- as.numeric(sumass$MAE)
sumass$ME <- as.numeric(sumass$ME)
print(sumass)

```

#Get best parameter values

```{r}
idx.min <- which.min(df_agg$RMSE)
  best.power <- df_agg$power[idx.min]
  best.Neighbors <- df_agg$nn[idx.min]
  min.RMSE <- df_agg$RMSE[idx.min]

best.parameters <- cbind(best.power, best.Neighbors, min.RMSE)
print(best.parameters)  
```

# Build IDW model based on best parameter values and compare
```{r}


idw.best <- idw(Dybde_m ~ 1, dfsp, grid_crop, nmax=best.Neighbors, idp=best.power)
idw.best <- idw(Dybde_m ~1, dfsp, grid_crop, nmax=10, idp=0.5)
idw.alt2 <- idw(Dybde_m ~ 1, dfsp, grid_crop, nmax=10, idp=1)
idw.alt3 <- idw(Dybde_m ~ 1, dfsp, grid_crop, nmax=10, idp=2)
idw.alt7 <- idw(Dybde_m ~ 1, dfsp, grid_crop, nmax=10, idp=4)
idw.alt4 <- idw(Dybde_m ~ 1, dfsp, grid_crop, nmax=neighbors, idp=1)
idw.alt5 <- idw(Dybde_m ~ 1, dfsp, grid_crop, nmax=neighbors, idp=2)
idw.alt6 <- idw(Dybde_m ~ 1, dfsp, grid_crop, nmax=neighbors, idp=4)

```

#Visualize the interpolations
```{r}
idw.best <- tmap_mode("plot") +
             tm_shape(idw.best)+
              tm_raster(title= "Torvdybde (m)", col="var1.pred", palette="-viridis", breaks=seq(from = 0, to = 3, by = 0.5)) +
            tm_shape(sf_shp)+
              tm_borders()   +
              tm_shape(dfsp)+
              tm_dots(col="black", size=0.05, alpha=0.5, ) +
              tm_compass(type="8star", position = c("right", "bottom"), size = 2) +
              tm_scale_bar(position = c("right", "bottom"), width = 0.3) +
                 tm_layout(title="idp: 0.5, nn:10", inner.margins = c(0.25, 0.1, 0.1, 0.1), legend.show = TRUE, legend.position = c("left","bottom"))

setwd('..')
tmap_save(idw.best, "Output/Opelandsmarka/idw.best.0.5_10.png")
```
 
```{r}
idw.1_10 <- tmap_mode("plot") +
             tm_shape(idw.alt2)+
              tm_raster(title= "Torvdybde (m)", col="var1.pred", palette="-viridis", breaks=seq(from = 0, to = 3, by = 0.5)) +
            tm_shape(sf_shp)+
              tm_borders()   +
              tm_shape(dfs)+
              tm_dots(col="black", size=0.05, alpha=0.5, ) +
              tm_compass(type="8star", position = c("right", "bottom"), size = 2) +
              tm_scale_bar(position = c("right", "bottom"), width = 0.3) +
                 tm_layout(title= "idp:1, nn:10", inner.margins = c(0.25, 0.1, 0.1, 0.1), legend.show = TRUE, legend.position = c("left", "bottom"))

setwd('..')
tmap_save(idw.1_10, "Output/Opelandsmarka/idw.1_10.png")

idw.1_10
```
 
```{r}
idw.2_10 <-      tmap_mode("plot") +
         tm_shape(idw.alt3)+
          tm_raster(title= "Torvdybde (m)", col="var1.pred", palette="-viridis", breaks=seq(from = 0, to = 3, by = 0.5)) +
        tm_shape(sf_shp)+
          tm_borders()   +
          tm_shape(dfs)+
          tm_dots(col="black", size=0.05, alpha=0.5, ) +
          tm_compass(type="8star", position = c("right", "bottom"), size = 2) +
          tm_scale_bar(position = c("right", "bottom"), width = 0.3) +
             tm_layout(title= "idp: 2, nn: 10", inner.margins = c(0.25, 0.1, 0.1, 0.1), legend.show = TRUE, legend.position = c("left", "bottom"))

setwd('..')
tmap_save(idw.2_10, "Output/Opelandsmarka/idw.2_10.png")

idw.2_10
```

```{r}
idw.1_Inf <-  tmap_mode("plot") +
               tm_shape(idw.alt4)+
                tm_raster(title= "Torvdybde (m)", col="var1.pred", palette="-viridis", breaks=seq(from = 0, to = 3, by = 0.5)) +
              tm_shape(sf_shp)+
                tm_borders()   +
                tm_shape(dfs)+
                tm_dots(col="black", size=0.05, alpha=0.5, ) +
                tm_compass(type="8star", position = c("right", "bottom"), size = 2) +
                tm_scale_bar(position = c("right", "bottom"), width = 0.3) +
                   tm_layout(title= "idp: 1, nn: Inf", inner.margins = c(0.25, 0.1, 0.1, 0.1), legend.show = TRUE, legend.position = c("left", "bottom"))

setwd('..')
tmap_save(idw.1_Inf, "Output/Opelandsmarka/idw.1_Inf.png")

idw.1_Inf
```

```{r}
idw.2_Inf <- tmap_mode("plot") +
             tm_shape(idw.alt5)+
              tm_raster(title= "Torvdybde (m)", col="var1.pred", palette="-viridis", breaks=seq(from = 0, to = 3, by = 0.5)) +
            tm_shape(sf_shp)+
              tm_borders()   +
              tm_shape(dfs)+
              tm_dots(col="black", size=0.05, alpha=0.5, ) +
              tm_compass(type="8star", position = c("right", "bottom"), size = 2) +
              tm_scale_bar(position = c("right", "bottom"), width = 0.3) +
                 tm_layout(title= "idp: 2, nn: Inf", inner.margins = c(0.25, 0.1, 0.1, 0.1), legend.show = TRUE, legend.position = c("left", "bottom"))


setwd('..')
tmap_save(idw.2_Inf, "Output/Opelandsmarka/idw.2_Inf.png")

idw.2_Inf
```

```{r}
idw.4_10 <- tmap_mode("plot") +
             tm_shape(idw.alt7)+
              tm_raster(title= "Torvdybde (m)", col="var1.pred", palette="-viridis", breaks=seq(from = 0, to = 3, by = 0.5)) +
            tm_shape(sf_shp)+
              tm_borders()   +
              tm_shape(dfs)+
              tm_dots(col="black", size=0.05, alpha=0.5, ) +
              tm_compass(type="8star", position = c("right", "bottom"), size = 2) +
              tm_scale_bar(position = c("right", "bottom"), width = 0.3) +
                 tm_layout(title= "idp: 4, nn: 10", inner.margins = c(0.25, 0.1, 0.1, 0.1), legend.show = TRUE, legend.position = c("left", "bottom"))


setwd('..')
tmap_save(idw.4_10, "Output/Opelandsmarka/idw.4_10.png")

idw.4_10
```

```{r}
 idw.4_Inf <-      tmap_mode("plot") +
           tm_shape(idw.alt6)+
            tm_raster(title= "Torvdybde (m)", col="var1.pred", palette="-viridis", breaks=seq(from = 0, to = 3, by = 0.5)) +
          tm_shape(sf_shp)+
            tm_borders()   +
            tm_shape(dfs)+
            tm_dots(col="black", size=0.05, alpha=0.5, ) +
            tm_compass(type="8star", position = c("right", "bottom"), size = 2) +
            tm_scale_bar(position = c("right", "bottom"), width = 0.3) +
               tm_layout(title= "idp: 4, nn: Inf", inner.margins = c(0.25, 0.1, 0.1, 0.1), legend.show = TRUE, legend.position = c("left", "bottom"))

setwd('..')
tmap_save(idw.4_Inf, "Output/Opelandsmarka/idw.4_Inf.png")

idw.4_Inf
```

#Plot residuals
```{r}
idw_cv_4_Inf <- gstat::krige.cv(Dybde_m~1, dfs, nmax=neighbors, set = list(idp = 4))
df_idw_cv_4_Inf <-data.frame(idw_cv_4_Inf)

plot(df_idw_cv_4_Inf$var1.pred, df_idw_cv_4_Inf$observed)

OP <- par(pty="s", mar=c(4,3,0,0))
  plot(df_idw_cv_4_Inf$var1.pred ~ df_idw_cv_4_Inf$observed, asp=1, xlab="Observed", ylab="Predicted", pch=16,
       col=rgb(0,0,0,0.5))
  abline(lm(df_idw_cv_4_Inf$var1.pred ~ df_idw_cv_4_Inf$observed), col="red", lw=2,lty=2)
  abline(0,1)
par(OP)

```

```{r}
idw_cv_4_Inf_sp <- as_Spatial(idw_cv_4_Inf)
bubble(idw_cv_4_Inf_sp, "residual")
```

```{r}
idw_cv_0.5_10 <- gstat::krige.cv(Dybde_m~1, dfs, nmax=10, set = list(idp = 0.5))
df_idw_cv_0.5_10 <-data.frame(idw_cv_0.5_10)

plot(df_idw_cv_0.5_10$var1.pred, df_idw_cv_0.5_10$observed)

OP <- par(pty="s", mar=c(4,3,0,0))
  plot(df_idw_cv_0.5_10$var1.pred ~ df_idw_cv_0.5_10$observed, asp=1, xlab="Observed", ylab="Predicted", pch=16,
       col=rgb(0,0,0,0.5))
  abline(lm(df_idw_cv_0.5_10$var1.pred ~ df_idw_cv_0.5_10$observed), col="red", lw=2,lty=2)
  abline(0,1)
par(OP)


```

```{r}
idw_cv_0.5_10_sp <- as_Spatial(idw_cv_0.5_10)
bubble(idw_cv_0.5_10_sp, "residual")
```

# Final map (this has to be rerun!)

```{r}
interpolated_map <- tmap_mode("plot") +
                    tm_shape(idw.best)+
                     tm_raster(title= "Peat depth (m)", col="var1.pred", palette="-viridis", alpha=0.8) +
                    tm_layout(legend.outside = TRUE) +
                    tm_shape(sf_shp)+
                     tm_borders()   +
                    tm_shape(dfsp)+
                     tm_dots(col="black", size=0.05, alpha=0.5, ) +
                    tm_compass(type="8star", position = c("left", "bottom"), size = 2) +
                    tm_scale_bar(position = c("left", "bottom"), width = 0.3) +
                        tm_layout(inner.margins = c(0.1, 0.1, 0.1, 0.1), legend.show = TRUE, legend.position = c("right", "top"))

interpolated_map
setwd('..')
tmap::tmap_save(interpolated_map, "Output/interpolation_Opelandsmarka.png")
```

