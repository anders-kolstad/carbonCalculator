---
title: "Interpolation_Kinn_Lista1"
author: "MarteFandrem"
date: "14 12 2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Packages needed
```{r}
library(readxl)
library(rgdal)
library(raster)
library(ggplot2)
library(gstat)
library(rgeos)
library(plyr)
library(dplyr)
library(sf)
library(maps)
library(maptools)
library(dplyr)
library(spatialEco)
library(stars)
library(automap)

```

#Import data
```{r}
lista1_kartpunkter<-readOGR(dsn="C:/Users/martef/DokumenterIntern/Kinn/Kartdata", layer="lista1_punkter")
shp_lista1<-readOGR(dsn="C:/Users/martef/DokumenterIntern/Kinn/Kartdata", layer="lista1_avgrensing")

Torvdybder_Lista1 <- read.csv("C:/Users/martef/DokumenterIntern/Kinn/Kartdata/lista1_punkter.csv", sep=",")
Data_Torvdybder_Lista1 <- read.csv("C:/Users/martef/DokumenterIntern/Kinn/Kartdata/data_lista1_torvdybder.csv", sep=";")
```

# Data cleaning
Merge peat depth info with shapefile.
Transform depths to numeric.
```{r}

lista1_kartpunkter@data$name <- as.numeric(lista1_kartpunkter@data$name)
lista1_kartpunkter <- merge(lista1_kartpunkter,Data_Torvdybder_Lista1,by="name")
lista1_kartpunkter@data$Dybde <- as.numeric(lista1_kartpunkter@data$Dybde)
```

#Visualizing imported data

```{r}
plot(shp_lista1)
points(lista1_kartpunkter, pch=1, col='red', cex=1)


```


# Spatial files to dataframes
```{r}
df_lista1<-fortify(shp_lista1)
df_lista1_punkter <- data.frame(lista1_kartpunkter)
```

#Visualize with ggplot



```{r}
p_myr_lista1 <- ggplot()
p_myr_lista1 <- p_myr_lista1 + geom_polygon( data=df_lista1, aes(x=long, y=lat, group=group),
                                             color="black", fill="lightblue", size = .1 ) +
  geom_point(data=df_lista1_punkter,
             aes(x=coords.x1,
                 y=coords.x2), pch=20, cex=1.2, col="red")
p_myr_lista1
```

#Check coordinate-system
```{r}
st_crs(lista1_kartpunkter) 
st_crs(shp_lista1)
```


#Has to be converted from WGS84 to UTM, to get metres as unit

```{r}

lista1_kartpunkter_UTM33 <- spTransform(lista1_kartpunkter, CRS("+init=epsg:25833")) 
shp_lista1_UTM33 <- spTransform(shp_lista1, CRS("+init=epsg:25833")) 
lista1_kartpunkter_UTM33 <- sp.na.omit(lista1_kartpunkter_UTM33, col.name = "Dybde") 
```

#Create grid


```{r}
grid_lista1 <- raster(extent(shp_lista1_UTM33))
res(grid_lista1) <- 1

proj4string(grid_lista1)<-proj4string(lista1_kartpunkter_UTM33)
gridpolygon_lista1 <- rasterToPolygons(grid_lista1)

plot(gridpolygon_lista1, cex=1.5)
points(lista1_kartpunkter_UTM33, pch=1, col='red', cex=1)

```

#Set crs for grid and dataframes
```{r}
proj4string(grid_lista1) <-crs(lista1_kartpunkter_UTM33) 
df_lista1<-fortify(shp_lista1_UTM33)
df_lista1_punkter <- data.frame(lista1_kartpunkter_UTM33)

```



#Inverse Distance Weighting (IDW) for Lista1

```{r}
gs_lista1 <- gstat(formula=Dybde~1, locations=lista1_kartpunkter_UTM33, nmax=5, set=list(idp = 0))
nn_lista1 <- interpolate(grid_lista1, gs_lista1)
## [inverse distance weighted interpolation]
crop_IDW_lista1 <- mask(nn_lista1, shp_lista1_UTM33)
plot(crop_IDW_lista1)

```
Summary of results

```{r}

print(summary(crop_IDW_lista1))


```
#Prepare output data
```{r}
raster_IDW_grid_lista1<-raster(nn_lista1)
raster_lista1<-raster(crop_IDW_lista1)
idw.output_lista1=as.data.frame(nn_lista1)

IDW.output_crop_lista1 <- na.omit(idw.output_lista1, col.name = "var1.pred") 
write.csv(IDW.output_crop_lista1,"IDW.output.lista1.csv", row.names = FALSE)
writeRaster(raster_IDW_grid_lista1,'IDW_lista1.tif', overwrite=TRUE)
writeRaster(raster_lista1,'IDW_lista1_crop.tif', overwrite=TRUE)


print(sum(IDW.output_crop_lista1))

```

#Grouping depths according to peat sampling

```{r}
IDW.output_crop_maroy$Dybde_gruppe <- cut(IDW.output_crop_maroy$var1.pred,c(0,10,60,110,Inf))
head(IDW.output_crop_maroy)


IDW.output_crop_maroy %>%
  group_by(Dybde_gruppe) %>%
  summarize(volum= sum(var1.pred, na.rm = TRUE), n=n())
```

# Visualize interpolation with ggplot

```{r}

raster_IDW_maroy_df <-rasterToPoints(raster_IDW_maroy)
raster_IDW_maroy_df <-data.frame(raster_IDW_maroy_df)
p_maroy <- 
  
ggplot() + 
  geom_raster(data=raster_IDW_maroy_df, aes(x=x, y=y))+ 
  geom_polygon( data=df_maroy, aes(x=long, y=lat),
     color="black", size = .1 ) +
  geom_point(data=df_maroy_punkter,
             aes(x=coords.x1,
                 y=coords.x2), pch=20, cex=1.2, col="red")
p_maroy
```
