---
title: "Random subsetting volume and mean"
author: "MarteFandrem"
date: "22 2 2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}

knitr::purl("Evaluating_best_practice.Rmd")

p <-NCmisc::list.functions.in.file("Evaluating_best_practice.R")
summary(p)
```


#Packages needed
```{r, echo=FALSE} 
library(readxl)
library(writexl)
library(rgdal)
library(raster)
library(gstat)
library(sf)
library(sp)
library(tmap)
library(dplyr)
library(rasterVis)
remove.packages(rgl)
install.packages("rgl")
library("rgl")
```


#Import and clean up data

```{r}

shp<-readOGR(dsn="C:/Users/martef/OneDrive - NTNU/Documents/Jobb-pc/PhD prosjekter/WP3 NINA GRAN/Data/Rydda datasett for kalkulator/Tydal", layer="stasjon_Setermyra")

df <- read.csv("C:/Users/martef/OneDrive - NTNU/Documents/Jobb-pc/PhD prosjekter/WP3 NINA GRAN/Data/Rydda datasett for kalkulator/Tydal/Torvdybder_Tydal.csv", sep=";")

# Make spatial dataframe of the peat depths points

dfs <- st_as_sf(x = df, 
                        coords = c("x", "y"),
                        crs = "+init=epsg:25833")

# Make sf file from sp shapefile
sf_shp <- st_as_sf(shp)

#Check projections
sf::st_crs(shp)
sf::st_crs(dfs)

#set same projection on all files
proj4string(shp)<-crs(dfs)

#make spatial file from data frame file
dfsp <- as(dfs, Class="Spatial")

#Crop dfsp to the extent of the station area
dfsp_station <- dfsp[shp,]

#Create sf of point data
sf_station <- st_as_sf(dfsp_station)


```

#Visualisere dataene

```{r}
tmap_mode("view")
  tm_shape(sf_shp)+
  tm_polygons() +
  tm_shape(dfs)+
  tm_dots(col="black", size=0.01, alpha=0.5, )

```


```{r}
data_Tydal <- tmap_mode("plot")+
                tm_shape(sf_shp)+
                 tm_polygons() +   
              tm_shape(dfsp_station)+
              tm_dots(col="Dybde", alpha=1, palette="-viridis", size=1 ) +
              tm_layout(legend.outside = TRUE)

data_Tydal
```

#Create grid and adjust to extent of peatland

```{r}
grid <- raster(extent(shp)) #create a raster grid from the extent of the peatland
res(grid) <- 1              #set resolution of the grid to 1x1m
proj4string(grid)<-crs(dfs) #set similar projection to the grid as to the datapoints

grid_sp <-as(grid, "SpatialPixels") #convert the grid from raster to spatialpixels

grid_sp@grid@cellsize       #check that cell size is 1x1

grid_crop <- grid_sp[shp,]  #crop the grid to only include the peatland
plot(grid_crop)
```
#Calculate distance between points
```{r}
euclidDist <- sp::spDists(dfsp_station,longlat = FALSE)
```

#Create 3Dplot
Does not work.
```{r}
idw <- idw(Dybde ~ 1, dfsp_station, grid_crop, nmax=8, idp=3)
idw_df <-as.data.frame(idw)
x <- idw_df$x
x1 <- sort.list(x)
x2 <- idw_df$x[x1]
y <- idw_df$y
y1 <- sort.list(y)
y2 <- idw_df$y[y1]
z <- idw_df$var1.pred
z <- as.matrix(data.frame(x=x,y=y))
z <- matrix(idw_df$var1.pred)
persp(x2, y2, z,
      theta = 135, phi = 30,
      col = "brown", scale = FALSE,
    ltheta = -120, shade = 0.75,
      border = NA, box = FALSE)
```
Create 3D-plot 2.
Trouble with packages
```{r}
idw_r <- raster(idw)
plot3D(idw_r)
```


What do I want to do?
-Randomly resample the dataset with 90%, 80%, 70%, 60%, 50%, 40%, 30% 20%, 10%, 5% of the points.
- Get mean volume and max + min, and/or coefficient of variance
- Run this 10 times per decrease in n
- Resample the dataset with increased distance between the points. How do I do this?



#Create random subsets

```{r}



for(i in 1:nrow(mtcars)) ifelse(i==7,break(),mc[[i]]<-mtcars[-(1:i),])

dataList = list()
for (i in seq(1, 10)){
    dataList[[i]] = mtcars[i:nrow(mtcars),]
}
```



#Interpolate all the various models and get the volume
```{r, echo=FALSE}
neighbors = length(dfsp_station$Dybde)
power = c(seq(from = 1, to = 4, by = 1))
neigh = c((1), seq(2,30,by = 2), c(length=(neighbors)))

temp <- data.frame()

for (i in power) {
  for (j in neigh) {
    
    temp2 <- NULL
    temp3 <- NULL
    temp4 <- NULL

    run = paste(i, j, sep="_")

    print(run)
    temp2 <- idw(Dybde ~ 1, dfsp_station, grid_crop, nmax=j, idp=i)
    temp3 <- as.data.frame(temp2@data)
    temp4 <- sum(temp3$var1.pred)
    temp5 <- cbind(run, temp4)
    temp  <- rbind(temp, temp5)
  }
} 

max <- max(volume$volume)
min <- min(volume$volume)
mean <- mean(volume$volume)
sd <- sd(volume$volume)


Description <- c("mean", "min", "max", "SD")
Results_volume <- data.frame(Description, Results = c(mean, min, max, sd)) 

```

```{r}
volume <- temp
volume <-dplyr::rename(volume, volume=temp4)
volume <- tidyr::separate(volume, 
                        run, 
                        into = c("power", "nn"),
                        sep = "_",
                        remove=F)
volume$power <- as.numeric(volume$power)
volume$nn <- as.numeric(volume$nn)
volume$volume <- as.numeric(volume$volume)

```

#Values for printing (mean, min, max, SD)
```{r}
max <- max(volume$volume)
min <- min(volume$volume)
mean <- mean(volume$volume)
sd <- sd(volume$volume)


Description <- c("mean", "min", "max", "SD")
Results_volume <- data.frame(Description, Results = c(mean, min, max, sd)) 

Results_volume
```

#Volume from area and mean
```{r}
area <- st_area(sf_shp)
```

```{r}
mean <- mean(dfsp_station$Dybde)
```

```{r}
roughvol <- mean*area
roughvol

```

